---
import DefaultLayout from '../../layouts/DefaultLayout.astro'
---

<DefaultLayout title="Media" description="Galleria e caricamenti di immagini e video per eventi a Piedelpoggio">
  <main class="bg-gradient-to-br from-primary-50/30 via-white to-secondary-50/20">
    <section class="relative overflow-hidden pt-12 md:pt-16">
      <div class="absolute inset-0 bg-gradient-to-b from-red-100/70 via-red-50/50 to-transparent"></div>
      <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 h-96 rounded-full blur-3xl opacity-40" style="background: radial-gradient(circle, rgba(255, 36, 0, 0.12) 0%, rgba(255, 36, 0, 0.04) 60%, transparent 100%);"></div>
      <div class="relative z-10 container mx-auto px-4 text-center">
        <div class="animate-fade-in">
          <div class="flex items-center justify-center mb-8">
            <div class="hidden md:flex w-20 h-20 rounded-xl sm:rounded-2xl items-center justify-center shadow-xl mr-6" style="background: linear-gradient(135deg, #FF2400, #E01E00);">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
            </div>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold leading-tight">
              <span class="bg-gradient-to-r from-red-700 via-red-600 to-red-500 bg-clip-text text-transparent">MEDIA</span>
            </h1>
          </div>
          <div class="w-32 h-1.5 rounded-full mx-auto mb-8" style="background: linear-gradient(to right, #FF2400, #E01E00, #CC1A00);"></div>
          <p class="text-lg md:text-xl lg:text-2xl text-gray-600 max-w-4xl mx-auto leading-relaxed font-medium mb-6 md:mb-16">Immagini e video organizzati per evento, con ricerca e filtri</p>
          <div class="flex flex-wrap justify-center gap-2 md:gap-3 mt-8 mb-6">
            <span class="px-3 py-1 text-xs md:text-sm font-medium text-red-700 bg-red-50 border border-red-200 shadow-sm rounded-full">Foto</span>
            <span class="px-3 py-1 text-xs md:text-sm font-medium text-orange-700 bg-orange-50 border border-orange-200 shadow-sm rounded-full">Video</span>
            <span class="px-3 py-1 text-xs md:text-sm font-medium text-pink-700 bg-pink-50 border border-pink-200 shadow-sm rounded-full">Eventi</span>
          </div>
        </div>
      </div>
    </section>
    <section class="pt-4 pb-16">
      <div class="container mx-auto px-4">

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200 p-4 md:p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
            <div class="flex-1 grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div>
                <div class="text-xs font-semibold text-gray-700 mb-1">Cerca Evento</div>
                <input id="searchEvents" type="text" placeholder="Es. Festa di Agosto" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" />
              </div>
              <div>
                <div class="text-xs font-semibold text-gray-700 mb-1">Data Inizio</div>
                <input id="dateFrom" type="date" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" />
              </div>
              <div>
                <div class="text-xs font-semibold text-gray-700 mb-1">Data Fine</div>
                <input id="dateTo" type="date" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" />
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="applyFilter" type="button" class="px-4 py-2 rounded-xl text-white shadow-md" style="background: linear-gradient(135deg, #2563EB, #4F46E5);">Applica</button>
              <button id="clearFilter" type="button" class="px-4 py-2 rounded-xl text-gray-700 border border-gray-300 hover:bg-gray-50">Reset</button>
            </div>
          </div>

          <div id="eventsGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>

        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200 p-4 md:p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-3">Carica contenuti</h2>
          <div class="mb-4 rounded-xl border border-blue-200/50 bg-blue-50/60 p-3">
            <div class="flex items-start gap-2">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z" />
              </svg>
              <div class="text-sm text-blue-900">
                <p class="font-semibold">Prima di caricare</p>
                <ul class="mt-1 space-y-1 list-disc pl-4">
                  <li>Verifica se l’evento è già presente nell’elenco e seleziona “Evento esistente”. In caso contrario crea un nuovo evento indicando nome e data.</li>
                  <li>Carica contenuti riferiti a un singolo evento. Se hai file di eventi diversi, effettua caricamenti separati.</li>
                </ul>
              </div>
            </div>
          </div>
          <form id="uploadForm" class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Evento</label>
              <input name="eventName" id="eventName" type="text" placeholder="Nome evento" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" required />
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Data evento</label>
                <input name="date" id="date" type="date" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" required />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Evento esistente</label>
                <select name="existingFolder" id="existingFolder" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600">
                  <option value="">Nuovo evento</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Se l’evento è già presente, selezionalo qui. Altrimenti lascia “Nuovo evento”.</p>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
              <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" placeholder="Descrizione dell'evento"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">File</label>
              <input name="files" id="files" type="file" multiple accept="image/*,video/*" class="sr-only" required />
              <label for="files" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white shadow-md cursor-pointer" style="background: linear-gradient(135deg, #2563EB, #4F46E5);">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v16h16V4H4zm4 4h8v8H8V8z"/>
                </svg>
                <span>Seleziona file</span>
              </label>
              <span id="filesSummary" class="ml-3 text-sm text-gray-600"></span>
            </div>
            <div class="flex items-center gap-3">
              <button type="submit" class="px-4 py-2 rounded-xl text-white shadow-md" style="background: linear-gradient(135deg, #2563EB, #4F46E5);">Carica</button>
              <span id="uploadStatus" class="text-sm text-gray-600"></span>
            </div>
          </form>
        </div>
      </div>
      </div>
    </section>
  </main>

  <script>
    let events = []
    async function loadEvents() {
      const res = await fetch('/api/media?list=events')
      const data = await res.json()
      events = Array.isArray(data.events) ? data.events : []
      renderEvents(events)
      populateFolders(events)
    }
    function populateFolders(list) {
      const sel = document.getElementById('existingFolder')
      if (!sel) return
      const current = sel.value
      sel.innerHTML = ''
      const opt0 = document.createElement('option')
      opt0.value = ''
      opt0.textContent = "Nuovo evento"
      sel.appendChild(opt0)
      list.forEach(ev => {
        const label = ev.meta && ev.meta.eventName ? `${ev.meta.eventName}` : humanize(ev.folder)
        const opt = document.createElement('option')
        opt.value = ev.folder
        opt.textContent = label
        sel.appendChild(opt)
      })
      sel.value = current
    }
    function formatDate(d) {
      const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre']
      const dt = new Date(d)
      return `${dt.getDate()} ${months[dt.getMonth()]} ${dt.getFullYear()}`
    }
    function matchesFilters(ev) {
      const q = (document.getElementById('searchEvents')?.value || '').toLowerCase().trim()
      const df = document.getElementById('dateFrom')?.value || ''
      const dt = document.getElementById('dateTo')?.value || ''
      const name = (ev.meta?.eventName || ev.folder || '').toLowerCase()
      if (q && !name.includes(q)) return false
      const evDate = ev.meta?.date || ''
      if (df && evDate < df) return false
      if (dt && evDate > dt) return false
      return true
    }
    function renderEvents(list) {
      const grid = document.getElementById('eventsGrid')
      if (!grid) return
      grid.innerHTML = ''
      const filtered = list.filter(matchesFilters)
      filtered.sort((a,b) => {
        const da = a.meta?.date || ''
        const db = b.meta?.date || ''
        return db.localeCompare(da)
      })
      filtered.forEach(ev => {
        const card = document.createElement('div')
        card.className = 'rounded-xl border border-gray-200 bg-white/70 overflow-hidden hover:shadow-lg transition'
        const cover = document.createElement('div')
        cover.className = 'grid grid-cols-3 gap-1 p-2 bg-gray-50'
        ;(ev.files || []).slice(0,3).forEach(f => {
          const isVideo = /\.(mp4|webm|ogg)$/i.test(f.name)
          const cell = document.createElement('div')
          cell.className = 'aspect-square rounded-lg overflow-hidden bg-gray-200'
          if (isVideo) {
            const v = document.createElement('video')
            v.src = f.url
            v.className = 'w-full h-full object-cover'
            v.muted = true
            v.autoplay = true
            v.loop = true
            cell.appendChild(v)
          } else {
            const img = document.createElement('img')
            img.src = f.url
            img.alt = ev.meta?.eventName || f.name
            img.loading = 'lazy'
            img.className = 'w-full h-full object-cover'
            cell.appendChild(img)
          }
          cover.appendChild(cell)
        })
        const info = document.createElement('div')
        info.className = 'p-3'
        const title = document.createElement('div')
        title.className = 'font-semibold text-gray-900 text-sm'
        title.textContent = ev.meta?.eventName || humanize(ev.folder)
        const date = document.createElement('div')
        date.className = 'text-xs text-gray-600'
        date.textContent = ev.meta?.date ? formatDate(ev.meta.date) : ''
        const desc = document.createElement('div')
        desc.className = 'text-xs text-gray-700 mt-1'
        desc.textContent = ev.meta?.description ? ev.meta.description : ''
        info.appendChild(title)
        info.appendChild(date)
        info.appendChild(desc)
        const openLink = document.createElement('a')
        openLink.className = 'mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-lg text-xs border border-gray-300 text-gray-700 hover:bg-gray-50'
        openLink.textContent = 'Apri galleria'
        openLink.href = `/media/${ev.folder}`
        info.appendChild(openLink)
        card.appendChild(cover)
        card.appendChild(info)
        
        grid.appendChild(card)
      })
    }
    document.getElementById('applyFilter')?.addEventListener('click', () => renderEvents(events))
    document.getElementById('searchEvents')?.addEventListener('input', () => renderEvents(events))
    document.getElementById('dateFrom')?.addEventListener('input', () => renderEvents(events))
    document.getElementById('dateTo')?.addEventListener('input', () => renderEvents(events))
    document.getElementById('clearFilter')?.addEventListener('click', () => {
      const s = document.getElementById('searchEvents') as HTMLInputElement | null
      const df = document.getElementById('dateFrom') as HTMLInputElement | null
      const dt = document.getElementById('dateTo') as HTMLInputElement | null
      if (s) s.value = ''
      if (df) df.value = ''
      if (dt) dt.value = ''
      renderEvents(events)
    })
    document.getElementById('uploadForm')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const formEl = document.getElementById('uploadForm') as HTMLFormElement
      const statusEl = document.getElementById('uploadStatus')
      const filesInput = document.getElementById('files') as HTMLInputElement | null
      if (!filesInput || !filesInput.files || filesInput.files.length === 0) {
        statusEl && (statusEl.textContent = 'Seleziona almeno un file')
        setTimeout(() => { statusEl && (statusEl.textContent = '') }, 3000)
        return
      }
      if (!formEl) return
      const fd = new FormData(formEl)
      ;(filesInput.files ? Array.from(filesInput.files) : []).forEach(f => fd.append('files', f))
      const res = await fetch('/api/media', { method: 'POST', body: fd })
      if (res.ok) {
        statusEl && (statusEl.textContent = 'Caricamento completato')
        await loadEvents()
        formEl.reset()
        const summary = document.getElementById('filesSummary')
        summary && (summary.textContent = '')
      } else {
        statusEl && (statusEl.textContent = 'Errore nel caricamento')
      }
      setTimeout(() => { statusEl && (statusEl.textContent = '') }, 4000)
    })
    document.getElementById('files')?.addEventListener('change', (e) => {
      const input = e.target as HTMLInputElement
      const summary = document.getElementById('filesSummary')
      const count = input.files ? input.files.length : 0
      if (summary) summary.textContent = count > 0 ? `${count} file selezionati` : ''
    })
    loadEvents()
  </script>
</DefaultLayout>
