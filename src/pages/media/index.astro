---
import DefaultLayout from '../../layouts/DefaultLayout.astro'
---

<DefaultLayout title="FOTO E VIDEO" description="Galleria e caricamenti di immagini e video per eventi a Piedelpoggio">
  <main class="bg-gradient-to-br from-primary-50/30 via-white to-secondary-50/20">
    <section class="relative overflow-hidden pt-12 md:pt-16">
      <div class="absolute inset-0 bg-gradient-to-b from-red-100/70 via-red-50/50 to-transparent"></div>
      <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 h-96 rounded-full blur-3xl opacity-40" style="background: radial-gradient(circle, rgba(255, 36, 0, 0.12) 0%, rgba(255, 36, 0, 0.04) 60%, transparent 100%);"></div>
      <div class="relative z-10 container mx-auto px-4 text-center">
        <div class="animate-fade-in">
          <div class="flex items-center justify-center mb-8">
            <div class="hidden md:flex w-20 h-20 rounded-xl sm:rounded-2xl items-center justify-center shadow-xl mr-6" style="background: linear-gradient(135deg, #FF2400, #E01E00);">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="9" cy="9" r="2"></circle>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 16l-6-6-7 7"/>
              </svg>
            </div>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold leading-tight">
              <span class="bg-gradient-to-r from-red-700 via-red-600 to-red-500 bg-clip-text text-transparent">FOTO E VIDEO</span>
            </h1>
          </div>
          <div class="w-32 h-1.5 rounded-full mx-auto mb-8" style="background: linear-gradient(to right, #FF2400, #E01E00, #CC1A00);"></div>
          <p class="text-lg md:text-xl lg:text-2xl text-gray-600 max-w-4xl mx-auto leading-relaxed font-medium mb-6 md:mb-16">Immagini e video organizzati per evento, con ricerca e filtri</p>
          <div class="flex flex-wrap justify-center gap-2 md:gap-3 mt-8 mb-6">
            <span class="px-3 py-1 text-xs md:text-sm font-medium text-red-700 bg-red-50 border border-red-200 shadow-sm rounded-full">Foto</span>
            <span class="px-3 py-1 text-xs md:text-sm font-medium text-orange-700 bg-orange-50 border border-orange-200 shadow-sm rounded-full">Video</span>
            <span class="px-3 py-1 text-xs md:text-sm font-medium text-pink-700 bg-pink-50 border border-pink-200 shadow-sm rounded-full">Eventi</span>
          </div>
        </div>
      </div>
    </section>
    <section class="pt-4 pb-16">
      <div class="container mx-auto px-4">
        

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200 p-4 md:p-6">
          <div class="bg-[#E01E00] rounded-xl border border-gray-200 p-3 md:p-4 mb-6">
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 items-end max-w-full">
              <div class="min-w-0 overflow-hidden">
                <div class="text-xs font-semibold text-white mb-1">Cerca Evento</div>
                <input id="searchEvents" type="text" placeholder="Es. Festa di Agosto" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" />
              </div>
              <div class="min-w-0 overflow-hidden">
                <div class="text-xs font-semibold text-white mb-1">Data Inizio</div>
                <input id="dateFrom" type="date" class="w-full max-w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" />
              </div>
              <div class="min-w-0 overflow-hidden">
                <div class="text-xs font-semibold text-white mb-1">Data Fine</div>
                <input id="dateTo" type="date" class="w-full max-w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" />
              </div>
              <div class="flex items-end justify-end min-w-0 overflow-hidden">
                <button id="clearFilter" type="button" class="px-4 py-2 rounded-xl bg-white text-[#E01E00] border border-white hover:bg-white/90">Reset</button>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 items-end max-w-full mt-2">
              <div class="min-w-0 overflow-hidden">
                <div class="text-xs font-semibold text-white mb-1">Ordina per</div>
                <select id="sortField" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 bg-white">
                  <option value="date">Data</option>
                  <option value="name">Nome</option>
                </select>
              </div>
              <div class="min-w-0 overflow-hidden">
                <div class="text-xs font-semibold text-white mb-1">Direzione</div>
                <select id="sortOrder" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 bg-white">
                  <option value="desc">Decrescente</option>
                  <option value="asc">Crescente</option>
                </select>
              </div>
            </div>
          </div>
          <div id="eventsGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 mt-2"></div>
        </div>

        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200 p-4 md:p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Carica contenuti</h2>
          <form id="uploadForm" class="space-y-4" autocomplete="off">
          <div class="mb-4">
            <div class="flex items-center gap-2 mb-3">
              <button id="modeExisting" type="button" class="px-3 py-1.5 rounded-full text-sm font-medium text-white" style="background: linear-gradient(135deg, #FF2400, #E01E00);">Aggiungi a evento esistente</button>
              <button id="modeNew" type="button" class="px-3 py-1.5 rounded-full text-sm font-medium text-gray-700 bg-white border border-gray-300">Crea nuovo evento</button>
              <button type="button" aria-label="Info" class="ml-auto flex-shrink-0 w-8 aspect-square rounded-full border border-red-300 text-red-700 hover:bg-red-50 flex items-center justify-center" data-info="event">
                <span class="text-sm font-bold">i</span>
              </button>
            </div>
            <div id="existingBox" class="mt-4 space-y-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">Evento esistente <span class="text-red-600">*</span></label>
              <div class="flex items-center gap-2">
                <div class="relative flex-1">
                  <input id="comboInput" type="text" placeholder="Seleziona evento esistente" autocomplete="off" autocapitalize="off" spellcheck="false" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500" />
                  <input id="existingFolderHidden" name="existingFolder" type="hidden" value="" />
                  <div id="comboSuggestions" class="absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-48 overflow-auto hidden z-50"></div>
                </div>
                <button id="changeExisting" type="button" class="hidden px-3 py-1.5 rounded-xl text-sm font-semibold text-white shadow-md hover:shadow-lg transition-all duration-300" style="background: linear-gradient(135deg, #FF2400, #E01E00);">Cambia</button>
              </div>
            </div>
            <div id="newEventFields" class="hidden mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Evento <span class="text-red-600">*</span></label>
                <input name="eventName" id="eventName" type="text" placeholder="Nome evento" maxlength="60" autocomplete="off" autocapitalize="off" spellcheck="false" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" required />
                <div id="nameLimitMsg" class="text-xs text-red-600 mt-1"></div>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4 max-w-full">
                <div class="min-w-0 overflow-hidden">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Data evento <span class="text-red-600">*</span></label>
                  <input name="date" id="date" type="date" autocomplete="off" class="w-full max-w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" required />
                </div>
              </div>
                <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label>
                <textarea name="description" id="description" rows="3" maxlength="200" autocomplete="off" autocapitalize="off" spellcheck="false" class="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600" placeholder="Descrizione dell'evento"></textarea>
                <div id="descLimitMsg" class="text-xs text-red-600 mt-1"></div>
              </div>
            </div>
          </div>
            <input name="files" id="files" type="file" multiple accept="image/*,video/*" autocomplete="off" class="sr-only" />
            <label class="block text-sm font-medium text-gray-700 mb-1">File <span class="text-red-600">*</span></label>
            <div id="dropzone" class="rounded-2xl border-2 border-dashed border-gray-300 bg-white p-8 text-center hover:bg-red-50">
              <div class="flex flex-col items-center justify-center gap-3">
                <p class="text-sm text-gray-700">Trascina qui immagini e video oppure <button type="button" id="pickFiles" class="text-red-600 hover:text-red-700 underline">carica file</button></p>
                <div id="filesSummary" class="text-sm text-gray-600"></div>
              </div>
            </div>
            <div class="text-xs text-gray-600 mt-2">Limite caricamento: <span class="font-semibold">1GB</span> totali</div>
            <div id="sizeLimitMsg" class="text-xs text-gray-600 mt-1"></div>
            <div id="uploadStatus" class="hidden text-sm font-medium rounded-xl border px-3 py-2 mt-2"></div>
            <div id="uploadProgress" class="hidden mt-3">
              <div class="text-xs text-gray-700 mb-1" id="uploadNote">Caricamento in corso — non chiudere la pagina</div>
              <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="uploadBar" class="bg-red-600 h-2 rounded-full" style="width:0%"></div>
              </div>
              <div id="uploadPercent" class="text-xs text-gray-700 mt-1">0%</div>
            </div>
            <button id="submitBtn" type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-white shadow-md disabled:opacity-50 disabled:cursor-not-allowed" style="background: linear-gradient(135deg, #FF2400, #E01E00);" disabled>Invia</button>
          </form>
        </div>
      </div>
      </div>
    </section>
    <div id="infoModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-xl w-[92%] max-w-md p-5 border border-red-200">
        <div class="flex items-center justify-between mb-3">
          <div id="infoTitle" class="text-base font-semibold text-gray-900"></div>
          <button id="infoClose" class="inline-flex items-center justify-center w-8 aspect-square rounded-full border border-red-300 text-red-700 hover:bg-red-50">✕</button>
        </div>
        <div id="infoBody" class="text-sm text-gray-700 leading-relaxed"></div>
      </div>
    </div>
  </main>

  <script>
    let events = []
    let externalFiles: File[] = []
    function clientCreateSlug(text) {
      return (text || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
    }
    function isDuplicateNewEvent(name, date) {
      if (!name || !date) return false
      const slug = clientCreateSlug(name)
      const folder = `${slug}-${date.replace(/-/g, '')}`
      return (events || []).some(ev => ev.folder === folder)
    }
    async function loadEvents() {
      try {
        const res = await fetch('/api/media?list=events')
        if (!res.ok) {
          console.error('loadEvents: response not ok', res.status)
          const grid = document.getElementById('eventsGrid')
          if (grid) {
            grid.innerHTML = '<div class="text-sm text-red-700 bg-red-50 border border-red-200 rounded-xl px-3 py-2">Errore nel caricamento degli eventi</div>'
          }
          events = []
          return
        }
        let data
        try {
          data = await res.json()
        } catch (e) {
          console.error('loadEvents: json parse error')
          const grid = document.getElementById('eventsGrid')
          if (grid) {
            grid.innerHTML = '<div class="text-sm text-red-700 bg-red-50 border border-red-200 rounded-xl px-3 py-2">Dati non validi ricevuti</div>'
          }
          events = []
          return
        }
        events = Array.isArray(data.events) ? data.events : []
        renderEvents(events)
        renderComboSuggestions('')
      } catch (err) {
        console.error('loadEvents: fetch failed')
        const grid = document.getElementById('eventsGrid')
        if (grid) {
          grid.innerHTML = '<div class="text-sm text-red-700 bg-red-50 border border-red-200 rounded-xl px-3 py-2">Impossibile contattare il server</div>'
        }
        events = []
      }
    }
    function clamp(text, max = 60) {
      const t = String(text || '')
      return t.length > max ? t.slice(0, max) + '…' : t
    }
    function formatDate(d) {
      const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre']
      const dt = new Date(d)
      return `${dt.getDate()} ${months[dt.getMonth()]} ${dt.getFullYear()}`
    }
    function matchesFilters(ev) {
      const q = (document.getElementById('searchEvents')?.value || '').toLowerCase().trim()
      const df = document.getElementById('dateFrom')?.value || ''
      const dt = document.getElementById('dateTo')?.value || ''
      const name = (ev.meta?.eventName || ev.folder || '').toLowerCase()
      if (q && !name.includes(q)) return false
      const evDate = ev.meta?.date || ''
      if (df && evDate < df) return false
      if (dt && evDate > dt) return false
      return true
    }
    function renderEvents(list) {
      const grid = document.getElementById('eventsGrid')
      if (!grid) return
      grid.innerHTML = ''
      const filtered = list.filter(matchesFilters)
      const sfEl = document.getElementById('sortField') as HTMLSelectElement | null
      const soEl = document.getElementById('sortOrder') as HTMLSelectElement | null
      const field = (sfEl?.value || 'date')
      const order = (soEl?.value || 'desc')
      filtered.sort((a,b) => {
        let va = ''
        let vb = ''
        if (field === 'name') {
          va = (a.meta?.eventName || a.folder || '').toLowerCase()
          vb = (b.meta?.eventName || b.folder || '').toLowerCase()
        } else {
          va = a.meta?.date || ''
          vb = b.meta?.date || ''
        }
        const cmp = va.localeCompare(vb)
        return order === 'desc' ? -cmp : cmp
      })
      filtered.forEach(ev => {
        const card = document.createElement('div')
        card.className = 'rounded-xl border border-gray-200 bg-white/70 overflow-hidden hover:shadow-lg transition h-full flex flex-col'
        const cover = document.createElement('div')
        cover.className = 'grid grid-cols-3 gap-1 p-2 bg-gray-50'
        ;(ev.files || []).slice(0,3).forEach(f => {
          const isVideo = /\.(mp4|webm|ogg)$/i.test(f.name)
          const cell = document.createElement('div')
          cell.className = 'aspect-square rounded-lg overflow-hidden bg-gray-200'
          if (isVideo) {
            const v = document.createElement('video')
            v.src = f.url
            v.className = 'w-full h-full object-cover'
            v.muted = true
            v.autoplay = true
            v.loop = true
            cell.appendChild(v)
          } else {
            const thumb = (f.thumb || '')
            const sizeBytes = Number((f.sizeBytes || 0))
            const ONE_MB = 1048576
            const src = thumb ? thumb : (sizeBytes > 0 && sizeBytes <= ONE_MB ? f.url : '')
            if (src) {
              const img = document.createElement('img')
              img.src = src
              img.alt = ev.meta?.eventName || f.name
              img.loading = 'lazy'
              img.className = 'w-full h-full object-cover'
              img.style.visibility = 'hidden'
              img.onerror = () => { try { cell.remove() } catch {} }
              img.addEventListener('load', () => { try { img.style.visibility = 'visible' } catch {} })
              cell.appendChild(img)
            } else {
              cell.className = 'aspect-square rounded-lg overflow-hidden bg-white'
            }
          }
          cover.appendChild(cell)
        })
        const info = document.createElement('div')
        info.className = 'p-3 flex flex-col flex-1'
        const title = document.createElement('div')
        title.className = 'font-semibold text-gray-900 text-base md:text-lg'
        title.textContent = clamp(ev.meta?.eventName || humanize(ev.folder), 60)
        const date = document.createElement('div')
        date.className = 'self-start w-fit inline-flex text-xs font-semibold text-red-700 bg-red-50 border border-red-200 rounded-full px-2 py-0.5 mt-1'
        date.textContent = ev.meta?.date ? formatDate(ev.meta.date) : ''
        const desc = document.createElement('div')
        desc.className = 'text-xs md:text-sm text-gray-700 mt-2 mb-2'
        desc.textContent = ev.meta?.description ? ev.meta.description : ''
        desc.style.textAlign = 'justify'
        ;(desc as any).style.textJustify = 'inter-word'
        const filesArr = (ev.files || [])
        const photosCount = filesArr.filter(f => !/\.(mp4|webm|ogg)$/i.test(f.name)).length
        const videosCount = filesArr.filter(f => /\.(mp4|webm|ogg)$/i.test(f.name)).length
        const counts = document.createElement('div')
        counts.className = 'flex items-center gap-2 mt-1 mb-2'
        const badgePhoto = document.createElement('span')
        badgePhoto.className = 'inline-flex text-xs font-semibold text-gray-700 bg-gray-100 border border-gray-200 rounded-full px-2 py-0.5'
        badgePhoto.textContent = `Foto: ${photosCount}`
        const badgeVideo = document.createElement('span')
        badgeVideo.className = 'inline-flex text-xs font-semibold text-gray-700 bg-gray-100 border border-gray-200 rounded-full px-2 py-0.5'
        badgeVideo.textContent = `Video: ${videosCount}`
        counts.appendChild(badgePhoto)
        counts.appendChild(badgeVideo)
        info.appendChild(title)
        info.appendChild(date)
        info.appendChild(desc)
        info.appendChild(counts)
        const actions = document.createElement('div')
        actions.className = 'mt-3 flex items-center gap-2 mt-auto'
        const openLink = document.createElement('a')
        openLink.className = 'inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl text-sm font-medium text-white flex-1 shadow-md hover:shadow-lg transition-all duration-300'
        openLink.textContent = 'Apri galleria'
        openLink.href = `/media/${ev.folder}`
        openLink.style.background = '#E01E00'
        const dlIcon = document.createElement('button')
        dlIcon.type = 'button'
        dlIcon.className = 'inline-flex items-center justify-center w-10 h-10 rounded-xl border border-red-600 bg-white text-red-700 hover:bg-red-50'
        dlIcon.setAttribute('aria-label', 'Scarica cartella')
        dlIcon.setAttribute('title', 'Scarica cartella')
        dlIcon.innerHTML = `
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v8m0 0l-4-4m4 4l4-4M4 18h16v2H4z" />
          </svg>
        `
        dlIcon.addEventListener('click', () => downloadFolderZip(ev.folder, ev.files || []))
        actions.appendChild(openLink)
        actions.appendChild(dlIcon)
        info.appendChild(actions)
        card.appendChild(cover)
        card.appendChild(info)
        
        grid.appendChild(card)
      })
    }
    async function ensureFflate() {
      const g = (window as any)
      if (g.fflate) return g.fflate
      await new Promise((resolve, reject) => { const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/fflate/umd/index.min.js'; s.onload = resolve; s.onerror = reject; document.head.appendChild(s) })
      return (window as any).fflate
    }
    function cfLowRes(url) {
      if (!url) return url
      const path = url.startsWith('/') ? url : '/' + url
      return `/cdn-cgi/image/fit=scale-down,width=500,quality=80,format=webp${path}`
    }

    async function downloadFolderZip(folder, files) {
      try {
        const fflate = await ensureFflate()
        const overlay = document.createElement('div')
        overlay.className = 'fixed inset-0 bg-black/40 z-50 flex items-center justify-center'
        const card = document.createElement('div')
        card.className = 'bg-white rounded-xl p-4 w-80 text-center shadow-lg'
        const title = document.createElement('div')
        title.className = 'text-sm font-semibold text-gray-800'
        title.textContent = 'Preparazione download — non chiudere la pagina'
        const barBox = document.createElement('div')
        barBox.className = 'w-full bg-gray-200 rounded-full h-2 mt-3 overflow-hidden'
        const bar = document.createElement('div')
        bar.className = 'bg-red-600 h-2 rounded-full'
        bar.style.width = '0%'
        const pct = document.createElement('div')
        pct.className = 'text-xs text-gray-700 mt-2'
        pct.textContent = '0%'
        barBox.appendChild(bar)
        card.appendChild(title)
        card.appendChild(barBox)
        card.appendChild(pct)
        overlay.appendChild(card)
        document.body.appendChild(overlay)
        const list = files.filter((it) => {
          const n = (it?.name || '').toLowerCase()
          const u = (it?.url || '').toLowerCase()
          if (!n) return false
          if (n.endsWith('.webp') || u.endsWith('.webp')) return false
          return true
        })
        let loaded = 0
        const total = list.length
        const map: any = {}
        for (const it of list) {
          const res = await fetch(it.url)
          const ab = await res.arrayBuffer()
          const u8 = new Uint8Array(ab)
          map[it.name] = u8
          loaded++
          const percent = Math.round((loaded / total) * 100)
          bar.style.width = percent + '%'
          pct.textContent = percent + '%'
        }
        const zip = fflate.zipSync(map, { level: 0 })
        const blob = new Blob([zip], { type: 'application/zip' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `${folder}.zip`
        document.body.appendChild(a)
        a.click()
        URL.revokeObjectURL(url)
        setTimeout(() => { overlay.remove() }, 500)
      } catch (e) {
        console.error('downloadFolderZip:error', e)
        alert('Errore nel preparare il download')
      }
    }
    let uploadMode = 'existing'
    function setModeButtons() {
      const mE = document.getElementById('modeExisting') as HTMLButtonElement | null
      const mN = document.getElementById('modeNew') as HTMLButtonElement | null
      if (mE && mN) {
        if (uploadMode === 'existing') {
          mE.style.background = 'linear-gradient(135deg, #FF2400, #E01E00)'
          mE.className = 'px-3 py-1.5 rounded-full text-sm font-medium text-white'
          mN.style.background = ''
          mN.className = 'px-3 py-1.5 rounded-full text-sm font-medium text-gray-700 bg-white border border-gray-300'
        } else {
          mN.style.background = 'linear-gradient(135deg, #FF2400, #E01E00)'
          mN.className = 'px-3 py-1.5 rounded-full text-sm font-medium text-white'
          mE.style.background = ''
          mE.className = 'px-3 py-1.5 rounded-full text-sm font-medium text-gray-700 bg-white border border-gray-300'
        }
      }
    }
    function updateUploadVisibility() {
      const existingVal = (document.getElementById('existingFolderHidden') as HTMLInputElement | null)?.value || ''
      const existingBox = document.getElementById('existingBox')
      const newFields = document.getElementById('newEventFields')
      const nameEl = document.getElementById('eventName') as HTMLInputElement | null
      const dateEl = document.getElementById('date') as HTMLInputElement | null
      
      setModeButtons()
      if (!newFields) return
      if (uploadMode === 'existing') {
        existingBox?.classList.remove('hidden')
        newFields.classList.add('hidden')
        nameEl && (nameEl.required = false)
        dateEl && (dateEl.required = false)
        if (existingVal) {
          const ev = (events || []).find(e => e.folder === existingVal)
          if (ev) {
          }
          if (comboInput) comboInput.readOnly = true
          changeExisting?.classList.remove('hidden')
        } else {
          if (comboInput) comboInput.readOnly = false
          changeExisting?.classList.add('hidden')
        }
      } else {
        existingBox?.classList.add('hidden')
        newFields.classList.remove('hidden')
        nameEl && (nameEl.required = true)
        dateEl && (dateEl.required = true)
        if (comboInput) comboInput.readOnly = false
        changeExisting?.classList.add('hidden')
      }
    }
    const comboInput = document.getElementById('comboInput') as HTMLInputElement | null
    const comboBox = document.getElementById('comboSuggestions')
    const existingHidden = document.getElementById('existingFolderHidden') as HTMLInputElement | null
    const changeExisting = document.getElementById('changeExisting') as HTMLButtonElement | null
    function labelFor(ev) {
      const name = ev.meta?.eventName || humanize(ev.folder)
      const d = ev.meta?.date ? ` — ${formatDate(ev.meta.date)}` : ''
      return name + d
    }
    function renderComboSuggestions(q) {
      if (!comboBox) return
      const list = (events || [])
        .filter(ev => {
          const name = (ev.meta?.eventName || ev.folder || '').toLowerCase()
          return q ? name.includes(q.toLowerCase()) : true
        })
        .slice(0, 50)
      comboBox.innerHTML = ''
      list.forEach(ev => {
        const item = document.createElement('button')
        item.type = 'button'
        item.className = 'w-full text-left px-3 py-2 hover:bg-red-50'
        item.textContent = labelFor(ev)
        item.addEventListener('click', () => {
          if (existingHidden) existingHidden.value = ev.folder
          if (comboInput) {
            comboInput.value = labelFor(ev)
            comboInput.readOnly = true
          }
          comboBox.classList.add('hidden')
          changeExisting?.classList.remove('hidden')
          updateUploadVisibility()
          updateSubmitEnabled()
          console.log('existing:selected', ev.folder)
        })
        comboBox.appendChild(item)
      })
    }
    comboInput?.addEventListener('input', (e) => {
      if (comboInput && comboInput.readOnly) return
      const q = (e.target as HTMLInputElement).value || ''
      renderComboSuggestions(q)
      comboBox?.classList.remove('hidden')
    })
    comboInput?.addEventListener('focus', () => {
      if (comboInput && comboInput.readOnly) return
      renderComboSuggestions(comboInput.value || '')
      comboBox?.classList.remove('hidden')
    })
    document.addEventListener('click', (e) => {
      if (!comboBox) return
      const target = e.target as HTMLElement
      const inside = target.closest('#comboSuggestions') || target.closest('#comboInput')
      if (!inside) comboBox.classList.add('hidden')
    })
    document.getElementById('modeExisting')?.addEventListener('click', () => {
      uploadMode = 'existing'
      updateUploadVisibility()
      updateSubmitEnabled()
      console.log('mode:set', uploadMode)
    })
    document.getElementById('modeNew')?.addEventListener('click', () => {
      uploadMode = 'new'
      if (existingHidden) existingHidden.value = ''
      if (comboInput) comboInput.value = ''
      updateUploadVisibility()
      updateSubmitEnabled()
      console.log('mode:set', uploadMode)
    })
    changeExisting?.addEventListener('click', () => {
      if (existingHidden) existingHidden.value = ''
      if (comboInput) {
        comboInput.readOnly = false
        comboInput.value = ''
        comboInput.focus()
      }
      renderComboSuggestions('')
      comboBox?.classList.remove('hidden')
      updateUploadVisibility()
      updateSubmitEnabled()
    })
    document.getElementById('eventName')?.addEventListener('input', () => updateSubmitEnabled())
    document.getElementById('date')?.addEventListener('input', () => updateSubmitEnabled())
    document.getElementById('searchEvents')?.addEventListener('input', () => renderEvents(events))
    document.getElementById('dateFrom')?.addEventListener('input', () => renderEvents(events))
    document.getElementById('dateTo')?.addEventListener('input', () => renderEvents(events))
    document.getElementById('clearFilter')?.addEventListener('click', () => {
      const s = document.getElementById('searchEvents') as HTMLInputElement | null
      const df = document.getElementById('dateFrom') as HTMLInputElement | null
      const dt = document.getElementById('dateTo') as HTMLInputElement | null
      if (s) s.value = ''
      if (df) df.value = ''
      if (dt) dt.value = ''
      renderEvents(events)
    })
    document.getElementById('sortField')?.addEventListener('change', () => renderEvents(events))
    document.getElementById('sortOrder')?.addEventListener('change', () => renderEvents(events))
    const MAX_TOTAL_BYTES = 1024 * 1024 * 1024
    function formatBytes(b) {
      const u = ['B','KB','MB','GB']
      let i = 0
      let v = b
      while (v >= 1024 && i < u.length - 1) { v /= 1024; i++ }
      return `${v.toFixed(i >= 2 ? 1 : 0)} ${u[i]}`
    }
    
    function totalSelectedBytes() {
      const input = document.getElementById('files') as HTMLInputElement | null
      const inputBytes = input && input.files ? Array.from(input.files).reduce((a,f)=>a+(f.size||0),0) : 0
      const dropBytes = externalFiles.reduce((a,f)=>a+(f.size||0),0)
      return inputBytes + dropBytes
    }
    function updateSizeLimitInfo() {
      const msg = document.getElementById('sizeLimitMsg')
      if (!msg) return
      const bytes = totalSelectedBytes()
      const over = bytes > MAX_TOTAL_BYTES
      msg.textContent = over ? `Limite superato: selezionati ${formatBytes(bytes)} su 1GB` : `Selezionati ${formatBytes(bytes)} su 1GB`
      msg.className = over ? 'text-xs text-red-700 mt-1' : 'text-xs text-gray-600 mt-1'
    }
    document.getElementById('uploadForm')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const formEl = document.getElementById('uploadForm') as HTMLFormElement
      const statusEl = document.getElementById('uploadStatus')
      const filesInput = document.getElementById('files') as HTMLInputElement | null
      console.log('submit:start', {
        uploadMode,
        existingFolder: (document.getElementById('existingFolderHidden') as HTMLInputElement | null)?.value || '',
        eventName: (document.getElementById('eventName') as HTMLInputElement | null)?.value || '',
        date: (document.getElementById('date') as HTMLInputElement | null)?.value || '',
        filesInputCount: filesInput && filesInput.files ? filesInput.files.length : 0,
        externalFilesCount: externalFiles.length
      })
      const hasAnyFiles = !!(filesInput && filesInput.files && filesInput.files.length > 0) || externalFiles.length > 0
      if (!hasAnyFiles) {
        if (statusEl) {
          statusEl.textContent = 'Seleziona almeno un file'
          statusEl.className = 'text-sm font-medium rounded-xl border px-3 py-2 mt-2 bg-red-50 text-red-700 border-red-300'
          statusEl.classList.remove('hidden')
        }
        setTimeout(() => { if (statusEl) statusEl.classList.add('hidden') }, 3000)
        return
      }
      const isValidEvent = (function(){
        const existing = (document.getElementById('existingFolderHidden') as HTMLInputElement | null)?.value || ''
        const nameEl = document.getElementById('eventName') as HTMLInputElement | null
        const dateEl = document.getElementById('date') as HTMLInputElement | null
        if (uploadMode === 'existing') return !!existing
        return !!(nameEl && nameEl.value && dateEl && dateEl.value)
      })()
      if (!isValidEvent) {
        if (statusEl) {
          statusEl.textContent = 'Completa i dati evento o seleziona evento esistente'
          statusEl.className = 'text-sm font-medium rounded-xl border px-3 py-2 mt-2 bg-red-50 text-red-700 border-red-300'
          statusEl.classList.remove('hidden')
        }
        setTimeout(() => { if (statusEl) statusEl.classList.add('hidden') }, 3000)
        return
      }
      if (uploadMode === 'new') {
        const name = (document.getElementById('eventName') as HTMLInputElement | null)?.value || ''
        const date = (document.getElementById('date') as HTMLInputElement | null)?.value || ''
        const duplicate = isDuplicateNewEvent(name, date)
        if (duplicate) {
          if (statusEl) {
            statusEl.textContent = 'Esiste già un evento con lo stesso nome e data. Usa "Evento esistente" oppure cambia nome/data.'
            statusEl.className = 'text-sm font-medium rounded-xl border px-3 py-2 mt-2 bg-red-50 text-red-700 border-red-300'
            statusEl.classList.remove('hidden')
          }
          setTimeout(() => { if (statusEl) statusEl.classList.add('hidden') }, 4000)
          return
        }
      }
      if (!formEl) return
      const progress = document.getElementById('uploadProgress')
      const bar = document.getElementById('uploadBar') as HTMLDivElement | null
      const pct = document.getElementById('uploadPercent')
      progress?.classList.remove('hidden')

      const filesInputList = filesInput && filesInput.files ? Array.from(filesInput.files) : []
      const sources: File[] = [...filesInputList, ...externalFiles]
      const allFiles: File[] = []
      for (const f of sources) {
        allFiles.push(f)
      }
      const totalBytesAll = allFiles.reduce((a, f) => a + (f.size || 0), 0)
      let uploadedBase = 0
      const RAW_THRESHOLD_BYTES = 100 * 1024 * 1024

      const existing = (document.getElementById('existingFolderHidden') as HTMLInputElement | null)?.value || ''
      const name = (document.getElementById('eventName') as HTMLInputElement | null)?.value || ''
      const date = (document.getElementById('date') as HTMLInputElement | null)?.value || ''
      const desc = (document.getElementById('description') as HTMLTextAreaElement | null)?.value || ''

      async function uploadOne(file: File) {
        return new Promise<void>((resolve, reject) => {
          const xhr = new XMLHttpRequest()
          let url = '/api/media'
          let fd: FormData | null = null
          if (file.size >= RAW_THRESHOLD_BYTES) {
            const params = new URLSearchParams()
            params.set('raw', '1')
            params.set('filename', file.name)
            if (file.type) params.set('contentType', file.type)
            if (existing) {
              params.set('existingFolder', existing)
            } else {
              params.set('eventName', name)
              params.set('date', date)
            }
            if (desc) params.set('description', desc)
            url = `/api/media?${params.toString()}`
            xhr.open('POST', url)
          } else {
            xhr.open('POST', url)
            fd = new FormData()
            if (existing) fd.append('existingFolder', existing)
            else { fd.append('eventName', name); fd.append('date', date) }
            if (desc) fd.append('description', desc)
            fd.append('files', file)
          }

          xhr.upload.onprogress = (evt) => {
            const totalLoaded = uploadedBase + (evt.loaded || 0)
            const percent = Math.round((totalLoaded / totalBytesAll) * 100)
            if (bar) bar.style.width = percent + '%'
            if (pct) pct.textContent = percent + '%'
          }
          xhr.onreadystatechange = () => {
            if (xhr.readyState === 4) {
              if (xhr.status >= 200 && xhr.status < 300) {
                uploadedBase += file.size || 0
                resolve()
              } else {
                let msg = ''
                try { msg = JSON.parse(xhr.responseText)?.error || xhr.responseText } catch { msg = xhr.responseText }
                reject(new Error(msg || 'Errore nel caricamento'))
              }
            }
          }
          if (fd) xhr.send(fd)
          else xhr.send(file)
        })
      }

      try {
        for (const f of allFiles) {
          if (!f || !f.name || f.size === 0) continue
          await uploadOne(f)
        }
        const originals = sources.map(f => f.name).filter(n => !!n)
        const existing = (document.getElementById('existingFolderHidden') as HTMLInputElement | null)?.value || ''
        const name = (document.getElementById('eventName') as HTMLInputElement | null)?.value || ''
        const date = (document.getElementById('date') as HTMLInputElement | null)?.value || ''
        const desc = (document.getElementById('description') as HTMLTextAreaElement | null)?.value || ''
        const folder = existing ? existing : `${clientCreateSlug(name)}-${date.replace(/-/g, '')}`
        try {
          await fetch('/api/media?notify=1', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ folder, eventName: name, date, description: desc, files: originals })
          })
        } catch {}
        await loadEvents()
        formEl.reset()
        const summary = document.getElementById('filesSummary')
        summary && (summary.textContent = '')
        externalFiles = []
        const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement | null
        submitBtn && (submitBtn.disabled = true)
        progress?.classList.add('hidden')
        if (bar) bar.style.width = '0%'
        if (pct) pct.textContent = '0%'
        if (statusEl) {
          statusEl.textContent = 'Caricamento completato'
          statusEl.className = 'text-sm font-medium rounded-xl border px-3 py-2 mt-3 bg-white/80 backdrop-blur-sm text-green-700 border-green-200 shadow-sm'
          setTimeout(() => { statusEl.classList.remove('hidden') }, 150)
        }
      } catch (err) {
        const msg = (err as any)?.message || String(err || '')
        console.error('submit:error', msg)
        if (statusEl) {
          statusEl.textContent = msg || 'Errore nel caricamento'
          statusEl.className = 'text-sm font-medium rounded-xl border px-3 py-2 mt-2 bg-red-50 text-red-700 border-red-300'
          statusEl.classList.remove('hidden')
        }
        progress?.classList.add('hidden')
        if (bar) bar.style.width = '0%'
        if (pct) pct.textContent = '0%'
      }
      setTimeout(() => { if (statusEl) statusEl.classList.add('hidden') }, 4000)
    })
    
    function updateSubmitEnabled() {
      const input = document.getElementById('files') as HTMLInputElement | null
      const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement | null
      const hasFiles = !!(input && input.files && input.files.length > 0) || externalFiles.length > 0
      const existing = (document.getElementById('existingFolderHidden') as HTMLInputElement | null)?.value || ''
      const nameEl = document.getElementById('eventName') as HTMLInputElement | null
      const dateEl = document.getElementById('date') as HTMLInputElement | null
      const hasEventInfo = uploadMode === 'existing' ? !!existing : !!(nameEl && nameEl.value && dateEl && dateEl.value)
      const hasDup = uploadMode === 'new' ? isDuplicateNewEvent(nameEl?.value || '', dateEl?.value || '') : false
      const sizeOk = totalSelectedBytes() <= MAX_TOTAL_BYTES
      const enabled = hasFiles && hasEventInfo && !hasDup && sizeOk
      submitBtn && (submitBtn.disabled = !enabled)
      console.log('updateSubmitEnabled', {
        enabled,
        hasFiles,
        hasEventInfo,
        hasDup,
        sizeOk,
        uploadMode,
        existing,
        eventName: nameEl?.value || '',
        date: dateEl?.value || '',
        inputFiles: input && input.files ? input.files.length : 0,
        externalFiles: externalFiles.length,
        totalBytes: totalSelectedBytes()
      })
      updateSizeLimitInfo()
    }
    document.getElementById('files')?.addEventListener('change', (e) => {
      const input = e.target as HTMLInputElement
      const summary = document.getElementById('filesSummary')
      const count = input.files ? input.files.length : 0
      externalFiles = []
      if (summary) summary.textContent = count > 0 ? `${count} file selezionati` : ''
      console.log('files:inputChange', { count })
      updateSubmitEnabled()
      updateSizeLimitInfo()
    })
    const dropzone = document.getElementById('dropzone')
    const pickFiles = document.getElementById('pickFiles')
    dropzone?.addEventListener('dragover', (e) => {
      e.preventDefault()
      dropzone.classList.add('bg-red-50')
      dropzone.classList.add('border-red-400')
    })
    dropzone?.addEventListener('dragleave', () => {
      dropzone.classList.remove('bg-red-50')
      dropzone.classList.remove('border-red-400')
    })
    dropzone?.addEventListener('drop', (e) => {
      e.preventDefault()
      const input = document.getElementById('files') as HTMLInputElement | null
      const summary = document.getElementById('filesSummary')
      const files = (e as DragEvent).dataTransfer?.files
      if (input && files) {
        externalFiles = Array.from(files)
        const countInput = input.files ? input.files.length : 0
        const countDrop = externalFiles.length
        const total = countInput + countDrop
        if (summary) summary.textContent = total > 0 ? `${total} file selezionati` : ''
        console.log('files:drop', { countInput, countDrop, total })
        updateSubmitEnabled()
        updateSizeLimitInfo()
      }
      dropzone.classList.remove('bg-red-50')
      dropzone.classList.remove('border-red-400')
    })
    pickFiles?.addEventListener('click', () => {
      const input = document.getElementById('files') as HTMLInputElement | null
      input?.click()
      console.log('files:pickClick')
    })
    const descEl = document.getElementById('description') as HTMLTextAreaElement | null
    const descMsg = document.getElementById('descLimitMsg')
    descEl?.addEventListener('input', () => {
      const len = (descEl?.value || '').length
      if (descMsg) descMsg.textContent = len >= 200 ? 'Hai raggiunto il limite di 200 caratteri' : ''
    })
    const evtNameEl = document.getElementById('eventName') as HTMLInputElement | null
    const nameMsg = document.getElementById('nameLimitMsg')
    evtNameEl?.addEventListener('input', () => {
      const len = (evtNameEl?.value || '').length
      if (nameMsg) nameMsg.textContent = len >= 60 ? 'Hai raggiunto il limite di 60 caratteri' : ''
    })
    const infoModal = document.getElementById('infoModal')
    const infoTitle = document.getElementById('infoTitle')
    const infoBody = document.getElementById('infoBody')
    const infoClose = document.getElementById('infoClose')
    function openInfo(key) {
      if (!infoModal || !infoTitle || !infoBody) return
      if (key === 'event' || key === 'files') {
        infoTitle.textContent = 'Come organizzare i caricamenti'
        infoBody.innerHTML = `
          <p style="text-align: justify; text-justify: inter-word;">
            Se l’evento è già presente, seleziona “Evento esistente”. In caso contrario crea un nuovo evento indicando nome e data.
          </p>
          <div class="my-3 border-t border-gray-200"></div>
          <p style="text-align: justify; text-justify: inter-word;">
            Carica sempre FOTO E VIDEO di <strong>un solo evento alla volta</strong>. Se hai file relativi a eventi diversi, effettua caricamenti separati per mantenere ordine e coerenza.
          </p>
        `
      }
      infoModal.classList.remove('hidden')
      infoModal.classList.add('flex')
    }
    document.querySelectorAll('[data-info]')?.forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.getAttribute('data-info')
        openInfo(key)
      })
    })
    function closeInfo() {
      if (!infoModal) return
      infoModal.classList.add('hidden')
      infoModal.classList.remove('flex')
    }
    infoClose?.addEventListener('click', closeInfo)
    infoModal?.addEventListener('click', (e) => {
      if (e.target === infoModal) closeInfo()
    })
    updateUploadVisibility()
    updateSubmitEnabled()
    loadEvents()
  </script>
  <style>
    input[type="date"]{width:100%;max-width:100%;box-sizing:border-box;-webkit-appearance:none;appearance:none}
    #dateFrom,#dateTo,#date{width:100%;max-width:100%;box-sizing:border-box}
  </style>
</DefaultLayout>
